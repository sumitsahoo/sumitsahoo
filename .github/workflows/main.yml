# =============================================================================
# GitHub Contribution Animation Generator
# =============================================================================
# This workflow generates an animated SVG snake game that visualizes GitHub
# contributions. The snake eats the contribution squares on the grid.
# =============================================================================

name: generate contribution animation

on:
  # Run automatically every Sunday at midnight UTC (weekly schedule)
  schedule:
    - cron: "0 0 * * 0" 
  
  # Allow manual triggering from GitHub Actions UI
  workflow_dispatch:
  
  # Trigger on every push to master branch (excluding asset changes)
  push:
    branches:
      - master
    # Ignore pushes that only change generated assets (prevents infinite loops)
    paths-ignore:
      - 'assets/**'

# Concurrency: Cancel any in-progress workflow runs for the same branch
# This prevents multiple runs from conflicting when pushing rapidly
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate:
    # Skip job if commit message contains [skip ci]
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    # Grant write permissions to push generated files back to repository
    permissions: 
      contents: write
    runs-on: ubuntu-latest
    # Prevent workflow from running indefinitely
    timeout-minutes: 5
    
    steps:
      # Step 1: Clone the repository to the runner
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Generate snake animation SVGs from GitHub contribution graph
      # Creates both light and dark theme versions of the animation
      - name: Generate snake animation from contributions
        id: generate-snake
        uses: Platane/snk@v3.4.1
        with:
          # Use repository owner's GitHub username for contribution data
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            assets/github-contribution.svg
            assets/github-contribution-dark.svg?palette=github-dark
        # Continue even if generation fails (e.g., GitHub API rate limit)
        continue-on-error: true

      # Step 3: Commit and push generated SVG files to master branch
      # Only runs if SVG generation was successful
      - name: Commit and push SVG files to master
        if: steps.generate-snake.outcome == 'success'
        run: |
          # Configure git user for the commit
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Stage only the generated SVG files
          git add assets/github-contribution.svg assets/github-contribution-dark.svg
          
          # Commit only if there are staged changes (prevents empty commits)
          # The [skip ci] tag prevents this commit from triggering another workflow run
          git diff --staged --quiet || git commit -m "chore: update GitHub contribution animation ($(date +'%Y-%m-%d %H:%M:%S UTC')) [skip ci]"
          
          # Push changes to remote repository
          git push

      # Step 4: Report if generation failed
      - name: Report generation failure
        if: steps.generate-snake.outcome == 'failure'
        run: |
          echo "::warning::Snake animation generation failed. This may be due to GitHub API rate limits or network issues."
          echo "The workflow will retry on the next scheduled run or manual trigger."